<!DOCTYPE html>
<html lang="vi" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chatbox Pro</title>
    <style>
        /* --- 1. VARIABLES --- */
        :root {
            --bg-body: #1a1a1a;
            --bg-sidebar: #202020;
            --bg-chat: #2d2d2d;
            --hover-item: #333333;
            --text-main: #e0e0e0;
            --text-sub: #9ca3af;
            --border: #404040;
            --msg-user: #007acc;
            --msg-bot: #404040;
            --input-bg: #404040;
        }
        [data-theme="light"] {
            --bg-body: #f3f4f6;
            --bg-sidebar: #ffffff;
            --bg-chat: #ffffff;
            --hover-item: #f3f4f6;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --border: #e5e7eb;
            --msg-user: #2563eb;
            --msg-bot: #f3f4f6;
            --input-bg: #e5e7eb;
        }

        /* --- 2. LAYOUT --- */
        body { margin: 0; font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; background: var(--bg-body); color: var(--text-main); overflow: hidden; }
        
        /* SIDEBAR (B√™n tr√°i) */
        .sidebar {
            width: 260px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: 0.3s;
        }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); }
        .new-chat-btn {
            width: 100%; padding: 12px; background: var(--msg-user); color: white;
            border: none; border-radius: 6px; cursor: pointer; font-weight: bold;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .new-chat-btn:hover { opacity: 0.9; }
        
        .history-list { flex: 1; overflow-y: auto; padding: 10px; }
        .history-item {
            padding: 10px 12px; margin-bottom: 4px; border-radius: 6px;
            cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            color: var(--text-sub); font-size: 0.9rem;
        }
        .history-item:hover { background: var(--hover-item); color: var(--text-main); }
        
        /* FOOTER SIDEBAR */
        .sidebar-footer { padding: 15px; border-top: 1px solid var(--border); display: flex; flex-direction: column; gap: 12px; }
        .user-info { display:flex; justify-content:space-between; align-items:center; color:var(--text-main); font-size:0.9rem; }
        .control-group { display: flex; gap: 8px; }

        /* MAIN CHAT (B√™n ph·∫£i) */
        .main-chat { flex: 1; display: flex; flex-direction: column; background: var(--bg-chat); position: relative; }
        
        /* CHAT HEADER (ƒê√£ ch·ªânh s·ª≠a) */
        .chat-header {
            padding: 12px 20px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            background: var(--bg-chat);
        }

        /* N√∫t Logout tr√™n Header */
        .btn-logout-header {
            background-color: #ef4444; 
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            border: none;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .btn-logout-header:hover { background-color: #dc2626; }

        /* CHAT AREA */
        .chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        
        .message { max-width: 80%; padding: 12px 16px; border-radius: 12px; line-height: 1.5; font-size: 0.95rem; }
        .user { align-self: flex-end; background: var(--msg-user); color: white; border-bottom-right-radius: 2px; }
        .bot { align-self: flex-start; background: var(--msg-bot); color: var(--text-main); border-bottom-left-radius: 2px; }

        .input-area { padding: 20px; border-top: 1px solid var(--border); display: flex; gap: 10px; background: var(--bg-chat); }
        input[type="text"] { flex: 1; padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-sidebar); color: var(--text-main); outline: none; }
        
        /* Utility Buttons */
        .icon-btn { background: var(--hover-item); border: 1px solid var(--border); color: var(--text-main); padding: 8px 12px; border-radius: 6px; cursor: pointer; flex: 1; }
        .icon-btn:hover { background: var(--border); }
        
        /* --- MODAL SETTINGS --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); z-index: 1000; justify-content: center; align-items: center;
        }
        .modal {
            background: var(--bg-sidebar); width: 400px; padding: 25px; border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5); border: 1px solid var(--border);
        }
        .modal h3 { margin-top: 0; color: var(--text-main); }
        .setting-item { margin-bottom: 20px; }
        .setting-item label { display: block; margin-bottom: 8px; color: var(--text-sub); font-size: 0.9rem; }
        .setting-item input[type="range"] { width: 100%; cursor: pointer; }
        .setting-value { float: right; color: var(--msg-user); font-weight: bold; }
        
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; }
        .btn-save { background: var(--msg-user); color: white; border: none; padding: 8px 20px; border-radius: 6px; cursor: pointer; }
        .btn-cancel { background: transparent; color: var(--text-sub); border: 1px solid var(--border); padding: 8px 20px; border-radius: 6px; cursor: pointer; }

    </style>
</head>
<body>

<div class="sidebar">
        <div class="sidebar-header">
            <button class="new-chat-btn" onclick="startNewChat()">+ Cu·ªôc tr√≤ chuy·ªán m·ªõi</button>
        </div>
        
        <div class="history-list" id="historyList">
            <div style="padding:10px; color:gray; font-style:italic">ƒêang t·∫£i l·ªãch s·ª≠...</div>
        </div>
        
        <div class="sidebar-footer">
            <div class="user-info">
                <span>üë§ {{ username }}</span>
                <span style="font-size: 0.8rem; color: var(--text-sub)">Online</span>
            </div>
            
            <div class="control-group">
                <button class="icon-btn" onclick="toggleTheme()" id="themeBtn" title="Giao di·ªán">‚òÄÔ∏è Theme</button>
                <button class="icon-btn" onclick="openSettings()" title="C√†i ƒë·∫∑t tham s·ªë">‚öôÔ∏è C√†i ƒë·∫∑t</button>
            </div>

            <div class="control-group">
                <button class="icon-btn" onclick="clearAll()" title="X√≥a to√†n b·ªô l·ªãch s·ª≠" style="color: #ef4444;">üóëÔ∏è X√≥a h·∫øt</button>
            </div>
        </div>
    </div>

    <div class="main-chat">
        <div class="chat-header">
            <div style="display: flex; align-items: center; gap: 10px;">
                <h3 style="margin:0">ü§ñ Chatbox AI</h3>
            </div>
            
            <a href="/logout" class="btn-logout-header">
                üö™ ƒêƒÉng xu·∫•t
            </a>
        </div>
        
        <div class="chat-box" id="chatBox">
            <div class="message bot">Xin ch√†o! B·∫°n mu·ªën h·ªèi g√¨ h√¥m nay?</div>
        </div>
        
        <div class="input-area">
            <input type="text" id="userInput" placeholder="Nh·∫≠p tin nh·∫Øn..." onkeypress="handleEnter(event)">
            <button class="new-chat-btn" style="width:auto" onclick="sendMessage()">G·ª≠i ‚û§</button>
        </div>
    </div>

    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <h3>‚öôÔ∏è C√†i ƒë·∫∑t tham s·ªë AI</h3>
            
            <div class="setting-item">
                <label>ƒê·ªô s√°ng t·∫°o (Temperature): <span id="tempValue" class="setting-value">0.7</span></label>
                <input type="range" id="tempInput" min="0.1" max="2.0" step="0.1" value="0.7" oninput="updateLabel('tempValue', this.value)">
            </div>
            
            <div class="setting-item">
                <label>ƒê·ªô d√†i t·ªëi ƒëa (Max Tokens): <span id="tokenValue" class="setting-value">256</span></label>
                <input type="range" id="tokenInput" min="64" max="2048" step="64" value="256" oninput="updateLabel('tokenValue', this.value)">
            </div>
            
             <div class="setting-item">
                <label>Top P: <span id="topPValue" class="setting-value">0.9</span></label>
                <input type="range" id="topPInput" min="0.1" max="1.0" step="0.05" value="0.9" oninput="updateLabel('topPValue', this.value)">
            </div>

            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeSettings()">H·ªßy</button>
                <button class="btn-save" onclick="saveSettings()">L∆∞u thay ƒë·ªïi</button>
            </div>
        </div>
    </div>

    <script>
        const chatBox = document.getElementById('chatBox');
        const userInput = document.getElementById('userInput');
        const historyList = document.getElementById('historyList');

        // --- 1. QU·∫¢N L√ù L·ªäCH S·ª¨ ---
        async function loadHistory() {
            try {
                const res = await fetch('/api/history');
                const list = await res.json();
                
                historyList.innerHTML = '';
                if(list.length === 0) {
                    historyList.innerHTML = '<div style="padding:10px; text-align:center; color:var(--text-sub)">Ch∆∞a c√≥ l·ªãch s·ª≠</div>';
                    return;
                }

                list.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'history-item';
                    div.innerText = item.title || "Cu·ªôc tr√≤ chuy·ªán kh√¥ng t√™n";
                    div.onclick = () => loadConversation(item.id);
                    historyList.appendChild(div);
                });
            } catch (e) { console.error("L·ªói t·∫£i history:", e); }
        }

        async function loadConversation(id) {
            chatBox.innerHTML = '<div style="text-align:center; padding:20px">‚è≥ ƒêang t·∫£i...</div>';
            try {
                const res = await fetch(`/api/load_chat/${id}`);
                const messages = await res.json();
                
                chatBox.innerHTML = ''; 
                if(messages.length === 0) {
                    chatBox.innerHTML = '<div class="message bot">Cu·ªôc tr√≤ chuy·ªán n√†y tr·ªëng.</div>';
                }
                messages.forEach(msg => appendMessage(msg.content, msg.role));
            } catch (e) {
                chatBox.innerHTML = '<div class="message bot">‚ùå L·ªói t·∫£i cu·ªôc tr√≤ chuy·ªán</div>';
            }
        }

        async function startNewChat() {
            await fetch('/new_chat', {method: 'POST'});
            chatBox.innerHTML = '<div class="message bot">B·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán m·ªõi! üëã</div>';
            loadHistory(); 
        }

        async function clearAll() {
            if(confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën X√ìA TO√ÄN B·ªò l·ªãch s·ª≠?")) {
                await fetch('/clear_all', {method: 'POST'});
                startNewChat();
            }
        }

        // --- 2. X·ª¨ L√ù CHAT ---
        function appendMessage(text, role) {
            const div = document.createElement('div');
            div.className = `message ${role}`;
            div.innerText = text;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            appendMessage(text, 'user');
            userInput.value = '';
            
            const isFirstMessage = chatBox.children.length <= 2;

            try {
                const res = await fetch('/get_response', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({msg: text})
                });
                const data = await res.json();
                appendMessage(data.response, 'bot');
                
                if(isFirstMessage) setTimeout(loadHistory, 1000);
                
            } catch (e) { appendMessage("L·ªói k·∫øt n·ªëi!", 'bot'); }
        }

        function handleEnter(e) { if(e.key === 'Enter') sendMessage(); }

        // --- 3. THEME ---
        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.getAttribute('data-theme') === 'dark';
            html.setAttribute('data-theme', isDark ? 'light' : 'dark');
            document.getElementById('themeBtn').innerText = isDark ? 'üåô Theme' : '‚òÄÔ∏è Theme';
            localStorage.setItem('theme', isDark ? 'light' : 'dark');
        }
        
        // --- 4. SETTINGS LOGIC ---
        function updateLabel(id, value) {
            document.getElementById(id).innerText = value;
        }

        async function openSettings() {
            try {
                const res = await fetch('/api/settings');
                const data = await res.json();
                
                document.getElementById('tempInput').value = data.temperature;
                updateLabel('tempValue', data.temperature);
                
                document.getElementById('tokenInput').value = data.max_tokens;
                updateLabel('tokenValue', data.max_tokens);
                
                document.getElementById('topPInput').value = data.top_p;
                updateLabel('topPValue', data.top_p);
                
                document.getElementById('settingsModal').style.display = 'flex';
            } catch (e) {
                alert("Kh√¥ng th·ªÉ t·∫£i c·∫•u h√¨nh!");
            }
        }

        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        async function saveSettings() {
            const settings = {
                temperature: document.getElementById('tempInput').value,
                max_tokens: document.getElementById('tokenInput').value,
                top_p: document.getElementById('topPInput').value
            };
            
            try {
                const res = await fetch('/api/settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(settings)
                });
                const data = await res.json();
                if(data.status === 'success') {
                    alert("‚úÖ ƒê√£ l∆∞u c√†i ƒë·∫∑t!");
                    closeSettings();
                } else {
                    alert("L·ªói: " + data.msg);
                }
            } catch (e) { alert("L·ªói k·∫øt n·ªëi!"); }
        }

        // Init
        document.documentElement.setAttribute('data-theme', localStorage.getItem('theme') || 'dark');
        loadHistory(); 
    </script>
</body>
</html>